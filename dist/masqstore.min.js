!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).MasqStore=e()}}(function(){return function e(t,n,r){function o(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(i)return i(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var d=n[a]={exports:{}};t[a][0].call(d.exports,function(e){var n=t[a][1][e];return o(n||e)},d,d.exports,e,t,n,r)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<r.length;a++)o(r[a]);return o}({1:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.deriveKey=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:18,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4;0===e.length&&(e=r(t));var i=new Uint8Array("");return crypto.subtle.importKey("raw",s(e),"PBKDF2",!1,["deriveBits","deriveKey"]).then(function(e){return crypto.subtle.deriveBits({name:"PBKDF2",salt:i,iterations:n,hash:"sha-256"},e,128)},o).then(function(e){return new Uint8Array(e)},o)};var r=n.randomString=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:18,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="";if(window.crypto&&window.crypto.getRandomValues){var r=new Uint32Array(e);window.crypto.getRandomValues(r);for(var o=0;o<e;o++)n+=t[r[o]%t.length]}else console.log("Your browser can't generate secure random numbers");return n},o=(n.encrypt=function(e,t,n){var r=window.crypto.getRandomValues(new Uint8Array(12));return function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"aes-gcm",i=arguments[4];return crypto.subtle.importKey("raw",t,{name:r},!0,["encrypt","decrypt"]).then(function(t){return crypto.subtle.encrypt({name:r,iv:n,additionalData:i},t,e).then(function(e){return new Uint8Array(e)},o)},o)}(s(t),e,r,"AES-GCM",s(n)).then(function(e){return{ciphertext:a(e),iv:a(r),version:n}},o)},n.decrypt=function(e,t){var n=i(t.ciphertext),r=s(t.version);return function(e,t,n,r,i){return crypto.subtle.importKey("raw",t,{name:r},!0,["encrypt","decrypt"]).then(function(t){return crypto.subtle.decrypt({name:r,iv:n,additionalData:i},t,e).then(function(e){return new Uint8Array(e)},o)},o)}(n,e,i(t.iv),"AES-GCM",r).then(function(e){return c(e)},o)},function(e){console.log(e)}),i=(n.getTag=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:128;return e.slice(e.byteLength-(t+7>>3))},n.hexStringToBuffer=function(e){if(e.length%2!=0)throw new Error("Invalid hexString");for(var t=new Uint8Array(e.length/2),n=0;n<e.length;n+=2){var r=parseInt(e.substr(n,2),16);if(isNaN(r))throw new Error("Invalid hexString");t[n/2]=r}return t}),a=n.bufferToHexString=function(e){if(!e)return null;for(var t=[],n=0;n<e.length;++n){var r=e[n].toString(16);r.length<2&&(r="0"+r),t.push(r)}return t.join("")},s=n.toArray=function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=[],n=0;n<e.length;++n)t.push(e.charCodeAt(n));return new Uint8Array(t)},c=n.toString=function(e){return String.fromCharCode.apply(null,new Uint8Array(e))}},{}],2:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(n,"__esModule",{value:!0}),n.unregisterApp=n.registerApp=n.syncApps=n.syncApp=n.init=void 0;var o=e("./store");Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return o[e]}})});var i=r(e("./sync")),a=r(o),s=(r(e("./permissions")),r(e("./crypto"))),c=r(e("./util")),u={},d=void 0,l="",f=["get","set","del","clear","getAll","setAll","user"],p=f,g=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];u.debug&&console.log("[Masq Store]",t)},y=(n.init=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(u=e,g("Initializing Masq Store..."),!a.available())try{return void window.parent.postMessage({"cross-storage":"unavailable"},"*")}catch(e){return g(e),e}void 0!==navigator.onLine?(window.addEventListener("online",function(){h(!0,e)}),window.addEventListener("offline",function(){h(!1,e)}),h(navigator.onLine,e)):y(e),window.addEventListener?window.addEventListener("message",v,!1):window.attachEvent("onmessage",v),window.parent.postMessage({"cross-storage":"listening"},"*"),g("Listening to clients...")},function e(t){if(!d||d.readyState!==d.OPEN){t||(t=u);var n=function(){g("..trying to reconnect"),setTimeout(function(){e(u)},3e3)};g("Initializing WebSocket with params:",t),i.initWSClient(t.syncserver,t.syncroom).then(function(e){d=e,t.cryptoKey&&(d.cryptoKey=s.hexStringToBuffer(t.cryptoKey)),i.check(d,l),d.onmessage=function(e){try{var t=JSON.parse(e.data);t.ciphertext&&d.cryptoKey?s.decrypt(d.cryptoKey,t).then(function(e){try{i.handleMessage(d,JSON.parse(e),l)}catch(e){console.log(e)}}).catch(function(e){console.log(e)}):i.handleMessage(d,t,l)}catch(e){g(e)}},d.onclose=function(e){g("WebSocket connection closed",e),!1!==e.wasClean&&1006!==e.code||n()}}).catch(function(e){g("Failed to initialize WebSocket.",e),n()})}}),v=function(e){var t=void 0,n=void 0,r=void 0,o=void 0;t="null"===e.origin?"file://":e.origin;try{r=e.data}catch(e){return}if(r.client&&(l=r.client),"ready"!==r["cross-storage"])if("poll"!==r["cross-storage"])if("init"!==r["cross-storage"]){if(r&&"string"==typeof r.method&&(o={client:l,result:{}},r.method)){if(r.updated=c.now(),o=a.prepareResponse(t,r,l),["set","setAll","del"].indexOf(r.method)>=0){var s=a.getMeta(t);s.sync&&(r.updated=s.updated,i.push(d,t,r))}n="file://"===t?"*":t,window.parent.postMessage(o,n)}}else!function(e,t){console.log("Initializing app "+e),u.autoregister&&w(e),window.parent.postMessage({"cross-storage":"ready"},e)}(t,r.params);else window.parent.postMessage({"cross-storage":"ready"},e.origin)},h=function(e,t){t.syncserver=t.syncserver||"ws://localhost:8080",e||c.isLocal(t.syncserver)?y(t):(d&&d.close(),g("Working offline."))},w=(n.syncApp=function(e){e&&e.length>0&&i.checkOne(d,l,e)},n.syncApps=function(){i.syncApps(d)},n.registerApp=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e&&e.length>0){var n=c.getOrigin(e);if(!a.exists(n)){a.setAll(n,{}),t.origin=n,t.permissions=t.permissions||p;var r=a.setMeta(n,t);return i.checkOne(d,l,n),g("Registered app:",n),r}}});n.unregisterApp=function(e){e&&0!==e.length&&(a.clear(e),a.clear(a.META+"_"+e))}},{"./crypto":1,"./permissions":3,"./store":4,"./sync":5,"./util":6}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.setPermissions=n.getPermissions=void 0;var r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("./store"));n.getPermissions=function(e){return r.getMeta(e).permissions||[]},n.setPermissions=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=r.getMeta(e);n.permissions=t,r.setMeta(e,n)}},{"./store":4}],4:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.available=n.exists=n.importJSON=n.exportJSON=n.metaList=n.appList=n.setMeta=n.getMeta=n.setAll=n.getAll=n.clearAll=n.clear=n.del=n.get=n.set=n.updateUser=n.user=n.prepareResponse=n.USER=n.META=void 0;var r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("./util")),o=window.localStorage,i=n.META="_meta",a=n.USER="_user",s=(n.prepareResponse=function(e,t,n){var r=void 0,o=void 0;if(v(e)){var i=g(e);t.updated&&(i.updated=t.updated);try{switch(t.method){case"user":o=s();break;case"get":o=u(e,t.params);break;case"set":c(e,t.params),o=y(e,i);break;case"del":d(e,t.params),o=y(e,i);break;case"clear":o=l(e);break;case"getAll":o=f(e);break;case"setAll":p(e,t.params),o=y(e,i)}}catch(e){r=e.message}}else r="UNREGISTERED";return{client:t.client||n,error:r,result:o}},n.user=function(){return f(a)}),c=(n.updateUser=function(e){return p(a,e)},n.set=function(e,t){var n=f(e);n[t.key]=t.value,o.setItem(e,JSON.stringify(n))}),u=n.get=function(e,t){var n=void 0,r=void 0,o=void 0;r=[],n=f(e);for(var i=0;i<t.keys.length;i++){try{o=n[t.keys[i]]}catch(e){o=null}r.push(o)}return r.length>1?r:r[0]},d=n.del=function(e,t){for(var n=f(e),r=0;r<t.keys.length;r++)delete n[t.keys[r]];o.setItem(e,JSON.stringify(n))},l=n.clear=function(e){o.removeItem(e)},f=(n.clearAll=function(){for(var e=0;e<o.length;e++)o.removeItem(o.key(e))},n.getAll=function(e){var t=o.getItem(e);if(!t||0===t.length)return{};try{return JSON.parse(t)}catch(e){return{}}}),p=n.setAll=function(e,t){o.setItem(e,JSON.stringify(t))},g=n.getMeta=function(e){return f(e?i+"_"+e:i)},y=n.setMeta=function(e,t){if(e){if(t.origin||(t.origin=e),e=e===i?i:i+"_"+e,t.updated){var n=g();n.updated=t.updated,o.setItem(i,JSON.stringify(n))}return o.setItem(e,JSON.stringify(t)),t}console.log("Missing origin when trying to set meta data.")},v=(n.appList=function(){for(var e=[],t=0;t<o.length;t++)0===o.key(t).indexOf("http")&&e.push(o.key(t));return e},n.metaList=function(){for(var e=[],t=0;t<o.length;t++){var n=o.key(t);0===n.indexOf(i+"_")&&n!==i&&e.push(n)}return e},n.exportJSON=function(){for(var e={},t=0;t<o.length;t++)e[o.key(t)]=f(o.key(t));return e},n.importJSON=function(e){if(e&&!r.isEmpty(e))for(var t in e)e.hasOwnProperty(t)&&p(t,e[t])},n.exists=function(e){for(var t=0;t<o.length;t++)if(o.key(t)===e)return!0;return!1});n.available=function(){var e=!0;try{o||(e=!1)}catch(t){e=!1,console.log(t)}return e}},{"./util":6}],5:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(n,"__esModule",{value:!0}),n.syncApps=n.checkOne=n.check=n.push=n.handleMessage=void 0,n.initWSClient=function(e,t){return new Promise(function(n,r){if(!e||!t)return r(new Error("No WebSocket server or room provided."));var o=void 0!==window.URL?new window.URL(t,e):e+t,i=new window.WebSocket(o);i.onopen=function(){return console.log("Connected to Sync server at "+o),n(i)},i.onerror=function(e){var t=new Error("Could not connect to Sync server at "+o);return r(t)}})};var o=r(e("./util")),i=r(e("./store")),a=r(e("./crypto")),s=(n.handleMessage=function(e,t,n){switch(t.type){case"sync":s(t,n);break;case"check":c(t,e,n);break;case"import":u(t,e,n);break;case"export":d(t,e,n)}},n.push=function(e,t,n){if(e&&0!==t.length&&0!==Object.keys(n.params).length){var r={type:"sync",origin:t,request:n};e.readyState===e.OPEN&&f(e,r)}},function(e,t){if(e.origin){var n=i.getMeta(e.origin);if(!o.inTheFuture(e.request.updated)&&!(o.isEmpty(n)||n.updated>e.request.updated)&&n.sync){i.prepareResponse(e.origin,e.request,t),e.client=e.request.client||t,e.sync=!0;var r="file://"===e.origin?"*":e.origin;window.self!==window.top&&window.parent.postMessage(e,r)}}}),c=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(i.exists(e.origin)&&void 0!==e.updated&&!o.inTheFuture(e.updated)){var r=i.getMeta(e.origin);if(e.updated>r.updated)l(t,n);else if(r.updated>0&&e.updated<r.updated){var a={type:"sync",client:e.client,origin:e.origin,request:{method:"setAll",updated:r.updated,params:i.getAll(e.origin)}};f(t,a)}}},u=function(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2];var n=i.metaList();if(0!==n.length){var r=n.map(function(e){var t={};return t.key=e,t.data=i.getAll(e),delete t.data.updated,t.data.sync=!1,t}),o={type:"export",client:e.client,origin:e.origin,list:r};console.log("Exporting:",o),f(t,o)}},d=function(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2];e.list&&Array.isArray(e.list)&&e.list.forEach(function(e){if(!i.exists(e.key)){i.setAll(e.key,e.data),console.log("Adding new app meta:",e);var t=new window.CustomEvent("syncapp",{detail:e.data});window.dispatchEvent(t)}})},l=n.check=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments[2];if(e){var r=n||i.metaList();if(0!==r.length)for(var o=0;o<r.length;o++){var a=i.getAll(r[o]);if(a.sync){a.updated=a.updated||0;var s={type:"check",client:t,origin:a.origin,updated:a.updated};f(e,s)}}}},f=(n.checkOne=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments[2];if(e){var r=i.getMeta(n);r.updated=r.updated||0;var o={type:"check",client:t,origin:r.origin,updated:r.updated};f(e,o)}},n.syncApps=function(e){if(e){f(e,{type:"import"})}},function(e,t){e.cryptoKey?a.encrypt(e.cryptoKey,JSON.stringify(t),"").then(function(t){e.send(JSON.stringify(t))}):e.send(JSON.stringify(t))})},{"./crypto":1,"./store":4,"./util":6}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=n.now=function(){return"function"==typeof Date.now?Date.now():(new Date).getTime()};n.inTheFuture=function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0)>o()+6e4},n.isEmpty=function(e){return 0===Object.keys(e).length},n.isObject=function(e){return"object"===(void 0===e?"undefined":r(e))},n.getOrigin=function(e){var t=void 0,n=void 0,r=void 0;return t=document.createElement("a"),t.href=e,t.host||(t=window.location),n=t.protocol&&":"!==t.protocol?t.protocol:window.location.protocol,r=n+"//"+t.host,r=r.replace(/:80$|:443$/,"")},n.isLocal=function(e){if(!e||0===e.length)return!1;for(var t=[/^(https?:\/\/|wss?:\/\/)?localhost+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?127\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?10\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?172\.(1[89]|2[0-9]|3[01])\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?192\.168\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?169\.254\.([1-9]|[1-9]\d|1\d\d|2([0-4]\d|5[0-4]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/],n=0;n<t.length;n++){var r=t[n];if(r instanceof RegExp&&r.test(e))return!0}return!1},n.dataToImg=function(e){var t=e.split(",")[1],n=void 0;n=e.split(",")[0].indexOf("base64")>=0?atob(t):decodeURI(t);for(var r=new ArrayBuffer(n.length),o=new Uint8Array(r),i=0;i<n.length;i++)o[i]=n.charCodeAt(i);return new Blob([o],{type:$scope.imageType})}},{}]},{},[2])(2)});