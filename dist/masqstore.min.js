!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).MasqStore=e()}}(function(){return function e(t,n,r){function i(s,a){if(!n[s]){if(!t[s]){var d="function"==typeof require&&require;if(!a&&d)return d(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=n[s]={exports:{}};t[s][0].call(u.exports,function(e){var n=t[s][1][e];return i(n||e)},u,u.exports,e,t,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(n,"__esModule",{value:!0}),n.unregisterApp=n.registerApp=n.syncApp=n.init=void 0;var i=e("./store");Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return i[e]}})});var o=r(e("./sync")),s=r(i),a=(r(e("./permissions")),r(e("./util"))),d={},c=void 0,u="",l=["get","set","del","clear","getAll","setAll","user"],f=l,p=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];d.debug&&console.log("[Masq Store]",t)},g=(n.init=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(d=e,p("Initializing Masq Store..."),!s.available())try{return void window.parent.postMessage({"cross-storage":"unavailable"},"*")}catch(e){return p(e),e}void 0!==navigator.onLine?(window.addEventListener("online",function(){y(!0,e)}),window.addEventListener("offline",function(){y(!1,e)}),y(navigator.onLine,e)):g(e),window.addEventListener?window.addEventListener("message",v,!1):window.attachEvent("onmessage",v),window.parent.postMessage({"cross-storage":"listening"},"*"),p("Listening to clients...")},function e(t){c&&c.readyState===c.OPEN||(t||(t=d),p("Initializing WebSocket with params:",t),o.initWSClient(t.syncserver,t.syncroom).then(function(t){c=t,o.check(c,u),c.onmessage=function(e){try{var t=JSON.parse(e.data);o.handleMessage(c,t,u)}catch(e){p(e)}},c.onclose=function(t){p("WebSocket connection closed"),!1!==t.wasClean&&1006!==t.code||(p("..trying to reconnect"),window.timerID||(window.timerID=setInterval(function(){e(d)},3e3)))}}).catch(function(e){p(e)}))}),v=function(e){var t=void 0,n=void 0,r=void 0,i=void 0;t="null"===e.origin?"file://":e.origin;try{r=e.data}catch(e){return}if(r.client&&(u=r.client),"ready"!==r["cross-storage"])if("poll"!==r["cross-storage"])if("init"!==r["cross-storage"]){if(r&&"string"==typeof r.method&&(i={client:u,result:{}},r.method)){if(r.updated=a.now(),i=s.prepareResponse(t,r,u),["set","setAll","del"].indexOf(r.method)>=0){var l=s.getMeta(t);l.sync&&(r.updated=l.updated,o.push(c,t,r))}n="file://"===t?"*":t,window.parent.postMessage(i,n)}}else!function(e,t){console.log("Initializing app "+e),d.autoregister&&h(e),window.parent.postMessage({"cross-storage":"ready"},e)}(t,r.params);else window.parent.postMessage({"cross-storage":"ready"},e.origin)},y=function(e,t){t.syncserver=t.syncserver||"ws://localhost:8080",e||a.isLocal(t.syncserver)?g(t):(c&&c.close(),p("Working offline."))},h=(n.syncApp=function(e){e&&e.length>0&&o.checkOne(c,u,e)},n.registerApp=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e&&e.length>0){var n=a.getOrigin(e);if(!s.exists(n)){s.setAll(n,{}),t.origin=n,t.permissions=t.permissions||f;var r=s.setMeta(n,t);return o.checkOne(c,u,n),p("Registered app:",n),r}}});n.unregisterApp=function(e){e&&0!==e.length&&(s.clear(e),s.clear(s.META+"_"+e))}},{"./permissions":2,"./store":3,"./sync":4,"./util":5}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.setPermissions=n.getPermissions=void 0;var r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("./store"));n.getPermissions=function(e){return r.getMeta(e).permissions||[]},n.setPermissions=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=r.getMeta(e);n.permissions=t,r.setMeta(e,n)}},{"./store":3}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.available=n.exists=n.importJSON=n.exportJSON=n.metaList=n.appList=n.setMeta=n.getMeta=n.setAll=n.getAll=n.clearAll=n.clear=n.del=n.get=n.set=n.updateUser=n.user=n.prepareResponse=n.USER=n.META=void 0;var r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("./util")),i=window.localStorage,o=n.META="_meta",s=n.USER="_user",a=(n.prepareResponse=function(e,t,n){var r=void 0,i=void 0;if(y(e)){var o=g(e);t.updated&&(o.updated=t.updated);try{switch(t.method){case"user":i=a();break;case"get":i=c(e,t.params);break;case"set":d(e,t.params),i=v(e,o);break;case"del":u(e,t.params),i=v(e,o);break;case"clear":i=l(e);break;case"getAll":i=f(e);break;case"setAll":p(e,t.params),i=v(e,o)}}catch(e){r=e.message}}else r="UNREGISTERED";return{client:t.client||n,error:r,result:i}},n.user=function(){return f(s)}),d=(n.updateUser=function(e){return p(s,e)},n.set=function(e,t){var n=f(e);n[t.key]=t.value,i.setItem(e,JSON.stringify(n))}),c=n.get=function(e,t){var n=void 0,r=void 0,i=void 0;r=[],n=f(e);for(var o=0;o<t.keys.length;o++){try{i=n[t.keys[o]]}catch(e){i=null}r.push(i)}return r.length>1?r:r[0]},u=n.del=function(e,t){for(var n=f(e),r=0;r<t.keys.length;r++)delete n[t.keys[r]];i.setItem(e,JSON.stringify(n))},l=n.clear=function(e){i.removeItem(e)},f=(n.clearAll=function(){for(var e=0;e<i.length;e++)i.removeItem(i.key(e))},n.getAll=function(e){var t=i.getItem(e);if(!t||0===t.length)return{};try{return JSON.parse(t)}catch(e){return{}}}),p=n.setAll=function(e,t){i.setItem(e,JSON.stringify(t))},g=n.getMeta=function(e){return f(e?o+"_"+e:o)},v=n.setMeta=function(e,t){if(e){if(t.origin||(t.origin=e),e=e===o?o:o+"_"+e,t.updated){var n=g();n.updated=t.updated,i.setItem(o,JSON.stringify(n))}return i.setItem(e,JSON.stringify(t)),t}console.log("Missing origin when trying to set meta data.")},y=(n.appList=function(){for(var e=[],t=0;t<i.length;t++)0===i.key(t).indexOf("http")&&e.push(i.key(t));return e},n.metaList=function(){for(var e=[],t=0;t<i.length;t++){var n=i.key(t);0===n.indexOf(o+"_")&&e.push(n)}return e},n.exportJSON=function(){for(var e={},t=0;t<i.length;t++)e[i.key(t)]=f(i.key(t));return e},n.importJSON=function(e){if(e&&!r.isEmpty(e))for(var t in e)e.hasOwnProperty(t)&&p(t,e[t])},n.exists=function(e){for(var t=0;t<i.length;t++)if(i.key(t)===e)return!0;return!1});n.available=function(){var e=!0;try{i||(e=!1)}catch(t){e=!1,console.log(t)}return e}},{"./util":5}],4:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(n,"__esModule",{value:!0}),n.checkOne=n.check=n.push=n.handleMessage=void 0,n.initWSClient=function(e,t){return new Promise(function(n,r){t=t||"foo",e=e||"wss://sync-beta.qwantresearch.com:8080";var i=void 0!==window.URL?new window.URL(t,e):e+t,o=new window.WebSocket(i);o.onopen=function(){return window.timerID&&(window.clearInterval(window.timerID),delete window.timerID),console.log("Connected to Sync server at "+i),n(o)},o.onerror=function(e){return r("Could not connect to Sync server at "+i)}})};var i=r(e("./util")),o=r(e("./store")),s=(n.handleMessage=function(e,t,n){switch(t.type){case"sync":s(t,n);break;case"check":a(t,e,n)}},n.push=function(e,t,n){if(e&&0!==t.length&&0!==Object.keys(n.params).length){var r={type:"sync",origin:t,request:n};e.readyState===e.OPEN&&e.send(JSON.stringify(r))}},function(e,t){if(e.origin){var n=o.getMeta(e.origin);if(!c(e.request.updated)&&!(i.isEmpty(n)||n.updated>e.request.updated)&&n.sync){o.prepareResponse(e.origin,e.request,t),e.client=t,e.sync=!0;var r="file://"===e.origin?"*":e.origin;window.self!==window.top&&window.parent.postMessage(e,r)}}}),a=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(o.exists(e.origin)&&void 0!==e.updated&&!c(e.updated)){var r=o.getMeta(e.origin);if(e.updated>r.updated)d(t,n);else if(r.updated>0){var i={type:"sync",client:e.client,origin:e.origin,request:{method:"setAll",updated:r.updated,params:o.getAll(e.origin)}};t.send(JSON.stringify(i))}}},d=n.check=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments[2];if(e){var r=n||o.metaList();if(0!==r.length)for(var i=0;i<r.length;i++){var s=o.getAll(r[i]);if(s.updated=s.updated||0,s.sync){var a={type:"check",client:t,origin:s.origin,updated:s.updated};e.send(JSON.stringify(a))}}}},c=(n.checkOne=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments[2];if(e){var r=o.getMeta(n);r.updated=r.updated||0;var i={type:"check",client:t,origin:r.origin,updated:r.updated};e.send(JSON.stringify(i))}},function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0)>i.now()})},{"./store":3,"./util":5}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.now=function(){return"function"==typeof Date.now?Date.now():(new Date).getTime()},n.isEmpty=function(e){return 0===Object.keys(e).length},n.isObject=function(e){return"object"===(void 0===e?"undefined":r(e))},n.getOrigin=function(e){var t=void 0,n=void 0,r=void 0;return t=document.createElement("a"),t.href=e,t.host||(t=window.location),n=t.protocol&&":"!==t.protocol?t.protocol:window.location.protocol,r=n+"//"+t.host,r=r.replace(/:80$|:443$/,"")},n.isLocal=function(e){if(!e||0===e.length)return!1;for(var t=[/^(https?:\/\/|wss?:\/\/)?localhost+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?127\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?10\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?172\.(1[89]|2[0-9]|3[01])\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?192\.168\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?169\.254\.([1-9]|[1-9]\d|1\d\d|2([0-4]\d|5[0-4]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/],n=0;n<t.length;n++){var r=t[n];if(r instanceof RegExp&&r.test(e))return!0}return!1},n.dataToImg=function(e){var t=e.split(",")[1],n=void 0;n=e.split(",")[0].indexOf("base64")>=0?atob(t):decodeURI(t);for(var r=new ArrayBuffer(n.length),i=new Uint8Array(r),o=0;o<n.length;o++)i[o]=n.charCodeAt(o);return new Blob([i],{type:$scope.imageType})}},{}]},{},[1])(1)});