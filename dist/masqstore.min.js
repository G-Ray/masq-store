!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).MasqStore=e()}}(function(){return function e(t,n,r){function o(a,s){if(!n[a]){if(!t[a]){var d="function"==typeof require&&require;if(!s&&d)return d(a,!0);if(i)return i(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var c=n[a]={exports:{}};t[a][0].call(c.exports,function(e){var n=t[a][1][e];return o(n||e)},c,c.exports,e,t,n,r)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<r.length;a++)o(r[a]);return o}({1:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(n,"__esModule",{value:!0}),n.init=void 0;var o=r(e("./sync")),i=r(e("./store")),a=!1,s=[],d=void 0,u="",c=["get","set","del","clear","getAll","setAll","getMeta"],l=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];a&&console.log(t)},f=(n.init=function(e){if(a=e.debug,!i.isAvailable())try{return window.parent.postMessage({"cross-storage":"unavailable"},"*")}catch(e){return}s=e.permissions||[],void 0!==navigator.onLine?(window.addEventListener("online",function(){y(!0,e)}),window.addEventListener("offline",function(){y(!1,e)}),y(navigator.onLine,e)):f(e),p()},function e(t){d&&d.readyState===d.OPEN||o.initWSClient(t.syncserver,t.syncroom).then(function(n){d=n,l("Checking for updates on other peers"),o.check(d,u),d.onmessage=function(e){try{var t=JSON.parse(e.data);o.handleMessage(d,t,u)}catch(e){l(e)}},d.onclose=function(n){l("WebSocket connection closed"),!1!==n.wasClean&&1006!==n.code||(l("..trying to reconnect"),window.timerID||(window.timerID=setInterval(function(){e(t)},3e3)))}}).catch(function(e){l(e)})}),p=function(){window.addEventListener?window.addEventListener("message",g,!1):window.attachEvent("onmessage",g),window.parent.postMessage({"cross-storage":"ready"},"*"),l("Listening to clients...")},g=function(e){var t=void 0,n=void 0,r=void 0,a=void 0;t="null"===e.origin?"file://":e.origin;try{r=e.data}catch(e){return}r.client&&(u=r.client),"ready"!==r["cross-storage"]&&("poll"!==r["cross-storage"]?r&&"string"==typeof r.method&&(a={client:u,result:{}},r.method&&(v(t,r.method)?(a=i.prepareResponse(t,r,u),["set","setAll","del"].indexOf(r.method)>=0&&(r.updated=a.result,o.push(d,t,r))):a.error="Invalid "+r.method+" permissions for "+t,l("Change detected: "+a),n="file://"===t?"*":t,window.parent.postMessage(a,n))):window.parent.postMessage({"cross-storage":"ready"},e.origin))},v=function(e,t){var n=void 0,r=void 0;if(c.indexOf(t)<0)return!1;for(n=0;n<s.length;n++)if((r=s[n]).origin instanceof RegExp&&r.allow instanceof Array&&r.origin.test(e)&&r.allow.indexOf(t)>=0)return!0;return!1},y=function(e,t){e?f(t):(d&&d.close(),l("Working offline."))}},{"./store":2,"./sync":3}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=window.localStorage,o=(n.prepareResponse=function(e,t,n){var r=void 0,c=void 0,l={updated:t.updated};try{switch(t.method){case"get":c=i(e,t.params);break;case"set":c=o(e,t.params,l);break;case"del":c=a(e,t.params,l);break;case"clear":c=s(e);break;case"getAll":c=d(e);break;case"setAll":c=u(e,t.params,l)}}catch(e){r=e.message}return{client:t.client||n,error:r,result:c}},n.set=function(e,t,n){var o=d(e);return o[t.key]=t.value,r.setItem(e,JSON.stringify(o)),c(e,n)}),i=n.get=function(e,t){var n=void 0,r=void 0,o=void 0;r=[],n=d(e);for(var i=0;i<t.keys.length;i++){try{o=n[t.keys[i]]}catch(e){o=null}r.push(o)}return r.length>1?r:r[0]},a=n.del=function(e,t,n){for(var o=d(e),i=0;i<t.keys.length;i++)delete o[t.keys[i]];return r.setItem(e,JSON.stringify(o)),c(e,n)},s=n.clear=function(e){r.removeItem(e)},d=n.getAll=function(e){var t=r.getItem(e);if(!t||0===t.length)return{};try{return JSON.parse(t)}catch(e){return{}}},u=n.setAll=function(e,t,n){return r.setItem(e,JSON.stringify(t)),c(e,n)},c=(n.getMeta=function(e){return d(e?"_meta_"+e:"_meta")},n.setMeta=function(e,t){var n=t.updated?t.updated:l(),o=d("_meta");return o.updated=n,r.setItem("_meta",JSON.stringify(o)),t.updated||(t.updated=n),r.setItem("_meta_"+e,JSON.stringify(t)),n}),l=(n.appList=function(){for(var e=[],t=0;t<r.length;t++)0!==r.key(t).indexOf("_")&&e.push(r.key(t));return e},n.metaList=function(){for(var e=[],t=0;t<r.length;t++){var n=r.key(t);0===n.indexOf("_meta_")&&e.push(n)}return e},n.exportJSON=function(){for(var e={},t=0;t<r.length;t++)e[r.key(t)]=d(r.key(t));return e},n.importJSON=function(e){if(e)for(var t in e)e.hasOwnProperty(t)&&u(t,e[t])},n.isAvailable=function(){var e=!0;try{r||(e=!1)}catch(t){e=!1}return e},n.now=function(){return"function"==typeof Date.now?Date.now():(new Date).getTime()})},{}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.check=n.push=n.handleMessage=void 0,n.initWSClient=function(e,t){return new Promise(function(n,r){e=e||"ws://localhost:8080",t=t||"foo";var o=void 0!==window.URL?new window.URL(t,e):e+t,i=new window.WebSocket(o);i.onopen=function(){return window.timerID&&(window.clearInterval(window.timerID),delete window.timerID),n(i)},i.onerror=function(e){return r("Could not connect to server at "+o)}})};var r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("./store")),o=(n.handleMessage=function(e,t,n){switch(t.type){case"sync":o(t,n);break;case"check":i(t,e,n)}},n.push=function(e,t,n){if(e&&0!==t.length&&0!==Object.keys(n.params).length){var r={type:"sync",origin:t,request:n};e.readyState===e.OPEN&&e.send(JSON.stringify(r))}},function(e,t){var n=r.getMeta(e.origin);if(!(s(e.request.updated)||n.updated>=e.request.updated)){console.log("Syncing data");var o=r.prepareResponse(e.origin,e.request,t);o.client=t,o.sync=!0;var i="file://"===e.origin?"*":e.origin;window.parent.postMessage(o,i)}}),i=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(e.updated&&!s(e.updated)){var o=r.getMeta(e.origin);if(e.updated>o.updated)a(t,n);else{var i={type:"sync",client:e.client,origin:e.origin,request:{method:"setAll",updated:o.updated,params:r.getAll(e.origin)}};t.send(JSON.stringify(i))}}},a=n.check=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(e)for(var n=r.metaList(),o=0;o<n.length;o++){var i=r.getAll(n[o]),a={type:"check",client:t,origin:n[o].split("_meta_")[1],updated:i.updated};e.send(JSON.stringify(a))}},s=function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0)>r.now()}},{"./store":2}]},{},[1])(1)});