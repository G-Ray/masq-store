!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).MasqStore=e()}}(function(){return function e(t,n,r){function o(s,a){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[s]={exports:{}};t[s][0].call(l.exports,function(e){var n=t[s][1][e];return o(n||e)},l,l.exports,e,t,n,r)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(n,"__esModule",{value:!0}),n.importJSON=n.exportJSON=n.appList=n.unregisterApp=n.registerApp=n.init=void 0;var o=r(e("./sync")),i=r(e("./store")),s=void 0,a=void 0,u="",c=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];s.debug&&console.log("[Masq Store]",t)},l=(n.init=function(e){if(s=e||{},!i.available())try{return window.parent.postMessage({"cross-storage":"unavailable"},"*")}catch(e){return}window.addEventListener?window.addEventListener("message",f,!1):window.attachEvent("onmessage",f),window.parent.postMessage({"cross-storage":"listening"},"*"),c("Listening to clients...")},function e(){a&&a.readyState===a.OPEN||o.initWSClient(s.syncserver,s.syncroom).then(function(t){a=t,o.check(a,u),a.onmessage=function(e){try{var t=JSON.parse(e.data);o.handleMessage(a,t,u)}catch(e){c(e)}},a.onclose=function(t){c("WebSocket connection closed"),!1!==t.wasClean&&1006!==t.code||(c("..trying to reconnect"),window.timerID||(window.timerID=setInterval(function(){e(s)},3e3)))}}).catch(function(e){c(e)})}),f=function(e){var t=void 0,n=void 0,r=void 0,c=void 0;t="null"===e.origin?"file://":e.origin;try{r=e.data}catch(e){return}r.client&&(u=r.client),"ready"!==r["cross-storage"]&&("poll"!==r["cross-storage"]?"init"!==r["cross-storage"]?r&&"string"==typeof r.method&&(c={client:u,result:{}},r.method&&(c=i.prepareResponse(t,r,u),["set","setAll","del"].indexOf(r.method)>=0&&(r.updated=c.result,o.push(a,t,r)),n="file://"===t?"*":t,window.parent.postMessage(c,n))):function(e,t){console.log("Attempting to initialize app: "+e),s=t||{},i.registerApp(e),void 0!==navigator.onLine?(window.addEventListener("online",function(){d(!0,s)}),window.addEventListener("offline",function(){d(!1,s)}),d(navigator.onLine,s)):l(),window.parent.postMessage({"cross-storage":"ready"},e)}(t,r):window.parent.postMessage({"cross-storage":"ready"},e.origin))},d=function(e,t){e?l():(a&&a.close(),c("Working offline."))};n.registerApp=function(e){i.registerApp(e)},n.unregisterApp=function(e){i.unregisterApp(e)},n.appList=function(){return i.appList()},n.exportJSON=function(){return i.exportJSON()},n.importJSON=function(e){i.importJSON(e)}},{"./store":2,"./sync":3}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.available=n.exists=n.importJSON=n.exportJSON=n.unregisterApp=n.registerApp=n.metaList=n.appList=n.setMeta=n.getMeta=n.setAll=n.getAll=n.clear=n.del=n.get=n.set=n.user=n.prepareResponse=n.META=n.USER=void 0;var r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("./util")),o=window.localStorage,i=n.USER="_user",s=n.META="_meta",a=(n.prepareResponse=function(e,t,n){var r=void 0,o=void 0,i={updated:t.updated};if(v(e))try{switch(t.method){case"user":o=a();break;case"get":o=c(e,t.params);break;case"set":u(e,t.params),o=g(e,i);break;case"del":l(e,t.params),o=g(e,i);break;case"clear":o=f(e);break;case"getAll":o=d(e);break;case"setAll":p(e,t.params),o=g(e,i)}}catch(e){r=e.message}else r="UNREGISTERED";return{client:t.client||n,error:r,result:o}},n.user=function(){return d(i)}),u=n.set=function(e,t,n){var r=d(e);r[t.key]=t.value,o.setItem(e,JSON.stringify(r))},c=n.get=function(e,t){var n=void 0,r=void 0,o=void 0;r=[],n=d(e);for(var i=0;i<t.keys.length;i++){try{o=n[t.keys[i]]}catch(e){o=null}r.push(o)}return r.length>1?r:r[0]},l=n.del=function(e,t,n){for(var r=d(e),i=0;i<t.keys.length;i++)delete r[t.keys[i]];o.setItem(e,JSON.stringify(r))},f=n.clear=function(e){o.removeItem(e)},d=n.getAll=function(e){var t=o.getItem(e);if(!t||0===t.length)return{};try{return JSON.parse(t)}catch(e){return{}}},p=n.setAll=function(e,t,n){o.setItem(e,JSON.stringify(t))},g=(n.getMeta=function(e){return d(e?s+"_"+e:s)},n.setMeta=function(e,t){var n=t.updated?t.updated:r.now(),i=d(s);return i.updated=n,o.setItem(s,JSON.stringify(i)),t.updated||(t.updated=n),o.setItem(s+"_"+e,JSON.stringify(t)),n}),v=(n.appList=function(){for(var e=[],t=0;t<o.length;t++)0===o.key(t).indexOf("http")&&e.push(o.key(t));return e},n.metaList=function(){for(var e=[],t=0;t<o.length;t++){var n=o.key(t);0===n.indexOf(s)&&e.push(n)}return e},n.registerApp=function(e){if(e&&0!==e.length){var t=r.getOrigin(e);v(t)||(o.setItem(t,"{}"),o.setItem(s+"_"+t,"{}"))}},n.unregisterApp=function(e){e&&(f(e),f(s+"_"+e))},n.exportJSON=function(){for(var e={},t=0;t<o.length;t++)e[o.key(t)]=d(o.key(t));return e},n.importJSON=function(e){if(e&&!r.isEmpty(e))for(var t in e)e.hasOwnProperty(t)&&p(t,e[t])},n.exists=function(e){for(var t=0;t<o.length;t++)if(o.key(t)===e)return!0;return!1});n.available=function(){var e=!0;try{o||(e=!1)}catch(t){e=!1,console.log(t)}return e}},{"./util":4}],3:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(n,"__esModule",{value:!0}),n.check=n.push=n.handleMessage=void 0,n.initWSClient=function(e,t){return new Promise(function(n,r){e=e||"ws://localhost:8080",t=t||"foo";var o=void 0!==window.URL?new window.URL(t,e):e+t,i=new window.WebSocket(o);i.onopen=function(){return window.timerID&&(window.clearInterval(window.timerID),delete window.timerID),n(i)},i.onerror=function(e){return r("Could not connect to server at "+o)}})};var o=r(e("./util")),i=r(e("./store")),s=(n.handleMessage=function(e,t,n){switch(t.type){case"sync":s(t,n);break;case"check":a(t,e,n)}},n.push=function(e,t,n){if(e&&0!==t.length&&0!==Object.keys(n.params).length){var r={type:"sync",origin:t,request:n};e.readyState===e.OPEN&&e.send(JSON.stringify(r))}},function(e,t){var n=i.getMeta(e.origin);if(!c(e.request.updated)&&!(!n||o.isEmpty(n)||n.updated>=e.request.updated)){console.log("Syncing data for",e.origin);var r=i.prepareResponse(e.origin,e.request,t);r.client=t,r.sync=!0;var s="file://"===e.origin?"*":e.origin;window.parent.postMessage(r,s)}}),a=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(e.updated&&!c(e.updated)){var r=i.getMeta(e.origin);if(e.updated>r.updated)u(t,n);else{var o={type:"sync",client:e.client,origin:e.origin,request:{method:"setAll",updated:r.updated,params:i.getAll(e.origin)}};t.send(JSON.stringify(o))}}},u=n.check=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(e){var n=i.metaList();if(0!==n.length){console.log("Checking for updates on other peers");for(var r=0;r<n.length;r++){var o=i.getAll(n[r]),s={type:"check",client:t,origin:n[r].split(i.META+"_")[1],updated:o.updated};e.send(JSON.stringify(s))}}}},c=function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0)>o.now()}},{"./store":2,"./util":4}],4:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.now=function(){return"function"==typeof Date.now?Date.now():(new Date).getTime()},n.isEmpty=function(e){return 0===Object.keys(e).length},n.isObject=function(e){return"object"===(void 0===e?"undefined":r(e))},n.getOrigin=function(e){var t=void 0,n=void 0,r=void 0;return t=document.createElement("a"),t.href=e,t.host||(t=window.location),n=t.protocol&&":"!==t.protocol?t.protocol:window.location.protocol,r=n+"//"+t.host,r=r.replace(/:80$|:443$/,"")}},{}]},{},[1])(1)});