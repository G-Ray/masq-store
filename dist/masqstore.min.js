!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).MasqStore=e()}}(function(){return function e(t,n,r){function o(s,a){if(!n[s]){if(!t[s]){var d="function"==typeof require&&require;if(!a&&d)return d(s,!0);if(i)return i(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=n[s]={exports:{}};t[s][0].call(u.exports,function(e){var n=t[s][1][e];return o(n||e)},u,u.exports,e,t,n,r)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(n,"__esModule",{value:!0}),n.unregisterApp=n.registerApp=n.init=void 0;var o=e("./store");Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return o[e]}})});var i=r(e("./sync")),s=r(o),a=r(e("./permissions")),d=r(e("./util")),c={},u=void 0,l="",f=["get","set","del","clear","getAll","setAll","user"],p=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];c.debug&&console.log("[Masq Store]",t)},g=(n.init=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(c=e,!s.available())try{return void window.parent.postMessage({"cross-storage":"unavailable"},"*")}catch(e){return e}void 0!==navigator.onLine?(window.addEventListener("online",function(){w(!0,e)}),window.addEventListener("offline",function(){w(!1,e)}),w(navigator.onLine,e)):g(e),window.addEventListener?window.addEventListener("message",v,!1):window.attachEvent("onmessage",v),window.parent.postMessage({"cross-storage":"listening"},"*"),p("Listening to clients...")},function e(t){u&&u.readyState===u.OPEN||(t||(t=c),p("Initializing WebSocket with params:",t),i.initWSClient(t.syncserver,t.syncroom).then(function(t){u=t,i.check(u,l),u.onmessage=function(e){try{var t=JSON.parse(e.data);i.handleMessage(u,t,l)}catch(e){p(e)}},u.onclose=function(t){p("WebSocket connection closed"),!1!==t.wasClean&&1006!==t.code||(p("..trying to reconnect"),window.timerID||(window.timerID=setInterval(function(){e(c)},3e3)))}}).catch(function(e){p(e)}))}),v=function(e){var t=void 0,n=void 0,r=void 0,o=void 0;t="null"===e.origin?"file://":e.origin;try{r=e.data}catch(e){return}r.client&&(l=r.client),"ready"!==r["cross-storage"]&&("poll"!==r["cross-storage"]?"init"!==r["cross-storage"]?r&&"string"==typeof r.method&&(o={client:l,result:{}},r.method&&(y(t,r.method)?(o=s.prepareResponse(t,r,l),["set","setAll","del"].indexOf(r.method)>=0&&(r.updated=o.result,i.push(u,t,r))):o.error="Invalid "+r.method+" permissions for "+t,n="file://"===t?"*":t,window.parent.postMessage(o,n))):function(e,t){console.log("Initializing app "+e),h(e),window.parent.postMessage({"cross-storage":"ready"},e)}(t,r.params):window.parent.postMessage({"cross-storage":"ready"},e.origin))},y=function(e,t){return!(f.indexOf(t)<0)&&(!!d.isLocal(e)||a.getPermissions(e).indexOf(t)>=0)},w=function(e,t){t.syncserver=t.syncserver||"ws://localhost:8080",e||d.isLocal(t.syncserver)?g(t):(u&&u.close(),p("Working offline."))},h=n.registerApp=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(e&&e.length>0){var n=d.getOrigin(e);if(!s.exists(n)){s.setItem(n,"{}");var r={origin:n,permissions:t,updated:0},o=s.META+"_"+n;s.setItem(o,JSON.stringify(r)),i.check(u,l,[o]),p("Registered app:",n)}}};n.unregisterApp=function(e){e&&(s.clear(e),s.clear(s.META+"_"+e))}},{"./permissions":2,"./store":3,"./sync":4,"./util":5}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.setPermissions=n.getPermissions=void 0;var r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("./store"));n.getPermissions=function(e){return r.getMeta(e).permissions||[]},n.setPermissions=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=r.getMeta(e);n.permissions=t,r.setMeta(e,n)}},{"./store":3}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.available=n.exists=n.importJSON=n.exportJSON=n.metaList=n.appList=n.setMeta=n.getMeta=n.setAll=n.getAll=n.clearAll=n.clear=n.del=n.get=n.set=n.setUser=n.user=n.prepareResponse=n.USER=n.META=void 0;var r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("./util")),o=window.localStorage,i=n.META="_meta",s=n.USER="_user",a=(n.prepareResponse=function(e,t,n){var r=void 0,o=void 0;if(y(e)){var i=g(e);t.updated&&(i.updated=t.updated);try{switch(t.method){case"user":o=a();break;case"get":o=c(e,t.params);break;case"set":d(e,t.params),o=v(e,i);break;case"del":u(e,t.params),o=v(e,i);break;case"clear":o=l(e);break;case"getAll":o=f(e);break;case"setAll":p(e,t.params),o=v(e,i)}}catch(e){r=e.message}}else r="UNREGISTERED";return{client:t.client||n,error:r,result:o}},n.user=function(){return f(s)}),d=(n.setUser=function(e){return p(s,e)},n.set=function(e,t){var n=f(e);n[t.key]=t.value,o.setItem(e,JSON.stringify(n))}),c=n.get=function(e,t){var n=void 0,r=void 0,o=void 0;r=[],n=f(e);for(var i=0;i<t.keys.length;i++){try{o=n[t.keys[i]]}catch(e){o=null}r.push(o)}return r.length>1?r:r[0]},u=n.del=function(e,t){for(var n=f(e),r=0;r<t.keys.length;r++)delete n[t.keys[r]];o.setItem(e,JSON.stringify(n))},l=n.clear=function(e){o.removeItem(e)},f=(n.clearAll=function(){for(var e=0;e<o.length;e++)o.removeItem(o.key(e))},n.getAll=function(e){var t=o.getItem(e);if(!t||0===t.length)return{};try{return JSON.parse(t)}catch(e){return{}}}),p=n.setAll=function(e,t){o.setItem(e,JSON.stringify(t))},g=n.getMeta=function(e){return f(e?i+"_"+e:i)},v=n.setMeta=function(e,t){if(e){e=e===i?i:i+"_"+e;var n=t.updated?t.updated:r.now(),s=g();return s.updated=n,o.setItem(i,JSON.stringify(s)),t.updated||(t.updated=n),o.setItem(e,JSON.stringify(t)),n}console.log("Missing origin when trying to set meta data.")},y=(n.appList=function(){for(var e=[],t=0;t<o.length;t++)0===o.key(t).indexOf("http")&&e.push(o.key(t));return e},n.metaList=function(){for(var e=[],t=0;t<o.length;t++){var n=o.key(t);0===n.indexOf(i+"_")&&e.push(n)}return e},n.exportJSON=function(){for(var e={},t=0;t<o.length;t++)e[o.key(t)]=f(o.key(t));return e},n.importJSON=function(e){if(e&&!r.isEmpty(e))for(var t in e)e.hasOwnProperty(t)&&p(t,e[t])},n.exists=function(e){for(var t=0;t<o.length;t++)if(o.key(t)===e)return!0;return!1});n.available=function(){var e=!0;try{o||(e=!1)}catch(t){e=!1,console.log(t)}return e}},{"./util":5}],4:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(n,"__esModule",{value:!0}),n.check=n.push=n.handleMessage=void 0,n.initWSClient=function(e,t){return new Promise(function(n,r){t=t||"foo";var o=void 0!==window.URL?new window.URL(t,e):e+t,i=new window.WebSocket(o);i.onopen=function(){return window.timerID&&(window.clearInterval(window.timerID),delete window.timerID),console.log("Connected to Sync server at "+o),n(i)},i.onerror=function(e){return r("Could not connect to Sync server at "+o)}})};var o=r(e("./util")),i=r(e("./store")),s=(n.handleMessage=function(e,t,n){switch(t.type){case"sync":s(t,n);break;case"check":a(t,e,n)}},n.push=function(e,t,n){if(e&&0!==t.length&&0!==Object.keys(n.params).length){var r={type:"sync",origin:t,request:n};e.readyState===e.OPEN&&e.send(JSON.stringify(r))}},function(e,t){if(e.origin){var n=i.getMeta(e.origin);if(!c(e.request.updated)&&!(!n||o.isEmpty(n)||n.updated>=e.request.updated)){console.log("Syncing data for",e,e.origin);var r=i.prepareResponse(e.origin,e.request,t);if(r.client=t,r.sync=!0,window.self!==window.top){var s="file://"===e.origin?"*":e.origin;window.parent.postMessage(r,s)}}}}),a=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(void 0!==e.updated&&!c(e.updated)){var r=i.getMeta(e.origin);if(e.updated>r.updated)d(t,n);else{var o={type:"sync",client:e.client,origin:e.origin,request:{method:"setAll",updated:r.updated,params:i.getAll(e.origin)}};t.send(JSON.stringify(o))}}},d=n.check=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments[2];if(e){var r=n||i.metaList();if(0!==r.length)for(var o=0;o<r.length;o++){var s=i.getAll(r[o]),a={type:"check",client:t,origin:s.origin,updated:s.updated};e.send(JSON.stringify(a))}}},c=function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0)>o.now()}},{"./store":3,"./util":5}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.now=function(){return"function"==typeof Date.now?Date.now():(new Date).getTime()},n.isEmpty=function(e){return 0===Object.keys(e).length},n.isObject=function(e){return"object"===(void 0===e?"undefined":r(e))},n.getOrigin=function(e){var t=void 0,n=void 0,r=void 0;return t=document.createElement("a"),t.href=e,t.host||(t=window.location),n=t.protocol&&":"!==t.protocol?t.protocol:window.location.protocol,r=n+"//"+t.host,r=r.replace(/:80$|:443$/,"")},n.isLocal=function(e){if(!e||0===e.length)return!1;for(var t=[/^(https?:\/\/|wss?:\/\/)?localhost+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?127\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?10\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?172\.(1[89]|2[0-9]|3[01])\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?192\.168\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/,/^(https?:\/\/|wss?:\/\/)?169\.254\.([1-9]|[1-9]\d|1\d\d|2([0-4]\d|5[0-4]))\.(\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))+(:[0-9]*)?/],n=0;n<t.length;n++){var r=t[n];if(r instanceof RegExp&&r.test(e))return!0}return!1},n.dataToImg=function(e){var t=e.split(",")[1],n=void 0;n=e.split(",")[0].indexOf("base64")>=0?atob(t):decodeURI(t);for(var r=new ArrayBuffer(n.length),o=new Uint8Array(r),i=0;i<n.length;i++)o[i]=n.charCodeAt(i);return new Blob([o],{type:$scope.imageType})}},{}]},{},[1])(1)});