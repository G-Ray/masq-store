!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).MasqStore=e()}}(function(){return function e(t,n,r){function i(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(o)return o(a,!0);var d=new Error("Cannot find module '"+a+"'");throw d.code="MODULE_NOT_FOUND",d}var u=n[a]={exports:{}};t[a][0].call(u.exports,function(e){var n=t[a][1][e];return i(n||e)},u,u.exports,e,t,n,r)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i}({1:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=window.localStorage,i=(n.prepareResponse=function(e,t,n){var r=void 0,u=void 0,l={updated:t.updated};try{switch(t.method){case"get":u=o(e,t.params);break;case"set":u=i(e,t.params,l);break;case"del":u=a(e,t.params,l);break;case"clear":u=s(e);break;case"getAll":u=c(e);break;case"setAll":u=d(e,t.params,l)}}catch(e){r=e.message}return{client:t.client||n,error:r,result:u}},n.set=function(e,t,n){var i=c(e);return i[t.key]=t.value,r.setItem(e,JSON.stringify(i)),u(e,n)}),o=n.get=function(e,t){var n=void 0,r=void 0,i=void 0;r=[],n=c(e);for(var o=0;o<t.keys.length;o++){try{i=n[t.keys[o]]}catch(e){i=null}r.push(i)}return r.length>1?r:r[0]},a=n.del=function(e,t,n){for(var i=c(e),o=0;o<t.keys.length;o++)delete i[t.keys[o]];return r.setItem(e,JSON.stringify(i)),u(e,n)},s=n.clear=function(e){r.removeItem(e)},c=n.getAll=function(e){var t=r.getItem(e);if(!t||0===t.length)return{};try{return JSON.parse(t)}catch(e){return{}}},d=n.setAll=function(e,t,n){return r.setItem(e,JSON.stringify(t)),u(e,n)},u=(n.getMeta=function(e){return c(e?"_meta_"+e:"_meta")},n.setMeta=function(e,t){var n=t.updated?t.updated:l(),i=c("_meta");return i.updated=n,r.setItem("_meta",JSON.stringify(i)),t.updated||(t.updated=n),r.setItem("_meta_"+e,JSON.stringify(t)),n}),l=(n.appList=function(){for(var e=[],t=0;t<r.length;t++)0!==r.key(t).indexOf("_")&&e.push(r.key(t));return e},n.metaList=function(){for(var e=[],t=0;t<r.length;t++){var n=r.key(t);0===n.indexOf("_meta_")&&e.push(n.split("_meta_")[1])}return e},n.exportJSON=function(){for(var e={},t=0;t<r.length;t++)e[r.key(t)]=c(r.key(t));return e},n.importJSON=function(e){if(e)for(var t in e)e.hasOwnProperty(t)&&d(t,e[t])},n.isAvailable=function(){var e=!0;try{r||(e=!1)}catch(t){e=!1}return e},n.now=function(){return"function"==typeof Date.now?Date.now():(new Date).getTime()})},{}],2:[function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(n,"__esModule",{value:!0}),n.init=void 0;var i=r(e("./sync")),o=r(e("./api")),a=!1,s=[],c=void 0,d="",u=["get","set","del","clear","getAll","setAll","getMeta"],l=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];a&&console.log(t)},f=(n.init=function(e){if(a=e.debug,!o.isAvailable())try{return window.parent.postMessage({"cross-storage":"unavailable"},"*")}catch(e){return}s=e.permissions||[],void 0!==navigator.onLine?(window.addEventListener("online",function(){w(!0,e)}),window.addEventListener("offline",function(){w(!1,e)}),w(navigator.onLine,e)):f(e),p()},function e(t){i.initWSClient(t.syncserver,t.syncroom).then(function(n){c=n,i.checkUpdates(c,d),c.onmessage=function(e){try{var t=JSON.parse(e.data);i.handleMessage(c,t,d)}catch(e){l(e)}},c.onclose=function(n){l("WebSocket connection closed"),!1!==n.wasClean&&1006!==n.code||(l("..trying to reconnect"),window.timerID||(window.timerID=setInterval(function(){e(t)},3e3)))}}).catch(function(e){l(e)})}),p=function(){window.addEventListener?window.addEventListener("message",g,!1):window.attachEvent("onmessage",g),window.parent.postMessage({"cross-storage":"ready"},"*"),l("Listening to clients...")},g=function(e){var t=void 0,n=void 0,r=void 0,a=void 0;t="null"===e.origin?"file://":e.origin;try{r=e.data}catch(e){return}r.client&&(d=r.client),"ready"!==r["cross-storage"]&&("poll"!==r["cross-storage"]?r&&"string"==typeof r.method&&(a={client:d,result:{}},r.method&&(v(t,r.method)?(a=o.prepareResponse(t,r,d),["set","setAll","del"].indexOf(r.method)>=0&&(r.updated=a.result,i.push(c,"update",t,r))):a.error="Invalid "+r.method+" permissions for "+t,l("Change detected: "+a),n="file://"===t?"*":t,window.parent.postMessage(a,n))):window.parent.postMessage({"cross-storage":"ready"},e.origin))},v=function(e,t){var n=void 0,r=void 0;if(u.indexOf(t)<0)return!1;for(n=0;n<s.length;n++)if((r=s[n]).origin instanceof RegExp&&r.allow instanceof Array&&r.origin.test(e)&&r.allow.indexOf(t)>=0)return!0;return!1},w=function(e,t){e?f(t):(c&&c.close(),l("Working offline."))}},{"./api":1,"./sync":3}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.checkUpdates=n.handleMessage=n.push=void 0,n.initWSClient=function(e,t){return new Promise(function(n,r){e=e||"ws://localhost:8080",t=t||"foo";var i=void 0!==window.URL?new window.URL(t,e):e+t,o=new window.WebSocket(i);o.onopen=function(){return window.timerID&&(window.clearInterval(window.timerID),delete window.timerID),n(o)},o.onerror=function(e){return r("Could not connect to server at "+i)}})};var r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("./api")),i=(n.push=function(e,t,n,r){if(e&&0!==n.length&&0!==Object.keys(r.params).length){var i={type:t,origin:n,request:r};e.send(JSON.stringify(i))}},n.handleMessage=function(e,t,n){switch(t.type){case"update":i(t,n);break;case"check":o(t,e)}},function(e,t){console.log("Incoming update");if(!(r.getMeta(e.origin).updated>=e.request.updated)){var n=r.prepareResponse(e.origin,e.request,t);n.client=t,n.sync=!0;var i="file://"===e.origin?"*":e.origin;window.parent.postMessage(n,i)}}),o=function(e,t){if(console.log("Incoming check"),e.lastModified){var n=r.getMeta(e.origin);if(n.updated>e.lastModified){var i={type:"update",client:e.client,origin:e.origin,request:{method:"setAll",updated:n.updated,params:r.getAll(e.origin)}};console.log("Pushing update",i),t.send(JSON.stringify(i))}}};n.checkUpdates=function(e,t){if(e)for(var n=r.metaList(),i=0;i<n.length;i++){var o=r.getAll("_meta_"+n[i]),a={type:"check",client:t,origin:n[i],lastModified:o.updated};e.send(JSON.stringify(a))}}},{"./api":1}]},{},[2])(2)});